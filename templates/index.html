{% extends "base.html" %}

{% block title %}{% if stock_data %}{{ stock_data.company_name }} ({{ stock_data.ticker }}) - Stock Insight AI{% else %}Stock Insight AI - ìŠ¤ë§ˆíŠ¸ íˆ¬ì ë¶„ì„ í”Œë«í¼{% endif %}{% endblock %}

{% block meta_description %}{% if stock_data %}{{ stock_data.company_name }} ({{ stock_data.ticker }}) AI ì£¼ì‹ ë¶„ì„ - í˜„ì¬ê°€, ê¸°ìˆ ì  ë¶„ì„, ë‰´ìŠ¤ ê°ì„± ë¶„ì„, ë§¤ìˆ˜/ë§¤ë„ ì˜ê²¬ ì œê³µ{% else %}Stock Insight AI - ì‹¤ì‹œê°„ ì£¼ì‹ ë¶„ì„, AI ê¸°ë°˜ íˆ¬ì ì¡°ì–¸, ê¸€ë¡œë²Œ ì§€ìˆ˜ ë° ë‰´ìŠ¤ ê°ì„± ë¶„ì„ í”Œë«í¼{% endif %}{% endblock %}

{% block og_title %}{% if stock_data %}{{ stock_data.company_name }} ({{ stock_data.ticker }}) - Stock Insight AI{% else %}Stock Insight AI - ìŠ¤ë§ˆíŠ¸ íˆ¬ì ë¶„ì„ í”Œë«í¼{% endif %}{% endblock %}

{% block og_description %}{% if stock_data %}{{ stock_data.company_name }}ì˜ AI ê¸°ë°˜ ì‹¤ì‹œê°„ ì£¼ì‹ ë¶„ì„ ë° íˆ¬ì ì˜ê²¬{% else %}AI ê¸°ë°˜ ì‹¤ì‹œê°„ ì£¼ì‹ ë¶„ì„ ë° íˆ¬ì ì¡°ì–¸ ì„œë¹„ìŠ¤{% endif %}{% endblock %}

{% block canonical_path %}{% if stock_data %}/stock/{{ stock_data.ticker }}{% else %}/{% endif %}{% endblock %}

{% block og_url %}{% if stock_data %}/stock/{{ stock_data.ticker }}{% endif %}{% endblock %}

{% block structured_data %}
{% if stock_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "FinancialProduct",
    "name": "{{ stock_data.company_name }} ({{ stock_data.ticker }})",
    "description": "{{ stock_data.company_name }} AI ê¸°ë°˜ ì£¼ì‹ ë¶„ì„ - í˜„ì¬ê°€, ê¸°ìˆ ì  ë¶„ì„, ë‰´ìŠ¤ ê°ì„± ë¶„ì„",
    "url": "https://stock-insight.app/stock/{{ stock_data.ticker }}",
    "provider": {
        "@type": "Organization",
        "name": "Stock Insight AI"
    },
    "category": "Stock Analysis"
}
</script>
{% endif %}
{% endblock %}

{% block content %}
<!-- Major Indices (ì½¤íŒ©íŠ¸ ë²„ì „) -->
<div class="glass-panel" style="padding: 0.85rem 1rem; margin-bottom: 1.25rem;">
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.65rem;">
        <span style="font-size: 1rem;">ğŸ“Š</span>
        <span style="font-size: 0.85rem; font-weight: 600; color: #94a3b8; letter-spacing: 0.04em;">ì‹¤ì‹œê°„ ê¸€ë¡œë²Œ ì§€ìˆ˜</span>
    </div>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        {% for region, indices in indices_data.items() %}
        {% for index in indices %}
        <a href="/stock/{{ index.ticker }}"
           style="text-decoration:none; display:flex; flex-direction:column; align-items:flex-start;
                  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
                  border-radius: 10px; padding: 0.5rem 0.75rem; min-width: 110px; flex: 1;
                  transition: border-color 0.2s;"
           onmouseover="this.style.borderColor='rgba(56,189,248,0.35)'"
           onmouseout="this.style.borderColor='rgba(255,255,255,0.06)'">
            <span style="font-size: 0.7rem; color: #64748b; margin-bottom: 0.15rem;">{{ index.name }}</span>
            <span style="font-size: 0.95rem; font-weight: 700; color: #f1f5f9;">
                {% if region == "í•œêµ­" %}{{ "{:,.0f}".format(index.current) }}
                {% else %}{{ "{:,.2f}".format(index.current) }}{% endif %}
            </span>
            <span style="font-size: 0.72rem; color: {% if index.change >= 0 %}#4ade80{% else %}#f87171{% endif %};">
                {{ "{:+.2f}".format(index.change_pct) }}%
            </span>
        </a>
        {% endfor %}
        {% endfor %}
    </div>
</div>

{% if stock_data %}
<!-- Stock Analysis Section -->
<div class="stock-header glass-panel {{ stock_data.verdict_class }}">
    <div class="stock-title-section">
        <h1 class="gradient-text">{{ stock_data.company_name }} ({{ stock_data.ticker }})</h1>
        <div class="verdict-badge"
            style="background: {{ stock_data.verdict_color }}22; color: {{ stock_data.verdict_color }}; border-color: {{ stock_data.verdict_color }}44;">
            {{ stock_data.verdict }}
        </div>
        <button class="share-btn" onclick="shareResult()">
            ğŸ”— ê²°ê³¼ ê³µìœ 
        </button>
    </div>
    <div class="stock-price-section">
        <div class="price-label">í˜„ì¬ê°€</div>
        <div class="price-value">{{ stock_data.currency_symbol }}{{ "{:,.2f}".format(stock_data.current_price) }}</div>
        <div class="price-change {% if stock_data.delta >= 0 %}positive{% else %}negative{% endif %}">
            {{ "{:+.2f}".format(stock_data.delta) }}
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="tabs-container">
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('chart', this)">ğŸ“Š ì°¨íŠ¸ & ë¶„ì„</button>
        <button class="tab-btn" onclick="showTab('financial', this)">ğŸ“‹ ì¬ë¬´ ì •ë³´</button>
        <button class="tab-btn" onclick="showTab('news', this)">ğŸ“° ë‰´ìŠ¤ & í‰íŒ</button>
        <button class="tab-btn" onclick="showTab('advice', this)">ğŸ¤– AI ì¡°ì–¸</button>
    </div>

    <!-- Chart Tab -->
    <div id="chart-tab" class="tab-content active">
        <div class="glass-panel" style="padding: 1.5rem;">
            <div id="chart-container" style="width: 100%; height: 650px; min-height: 650px;"></div>
        </div>
    </div>

    <!-- Financial Tab -->
    <div id="financial-tab" class="tab-content">
        <div class="glass-panel">
            <h3>ğŸ“ ê¸°ì—… ê°œìš”</h3>
            <div class="summary-text">{{ stock_data.summary }}</div>
        </div>

        <div class="glass-panel">
            <h3>ğŸ’ ì£¼ìš” ì§€í‘œ</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">ì‹œê°€ì´ì•¡</div>
                    <div class="metric-value">{{ stock_data.market_cap }}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">PER</div>
                    <div class="metric-value">{{ stock_data.pe_ratio }}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ë°°ë‹¹ìˆ˜ìµë¥ </div>
                    <div class="metric-value">
                        {% if stock_data.dividend_yield %}
                        {{ "{:.2f}".format(stock_data.dividend_yield) }}%
                        {% else %}
                        N/A
                        {% endif %}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">PBR</div>
                    <div class="metric-value">{{ stock_data.pbr }}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ROE</div>
                    <div class="metric-value">{{ stock_data.roe }}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">EPS</div>
                    <div class="metric-value">{{ stock_data.eps }}</div>
                </div>
                <div class="metric-card wide-card">
                    <div class="metric-label">52ì£¼ ê°€ê²© ë²”ìœ„</div>
                    <div class="metric-value">
                        {% if stock_data.week52_low and stock_data.week52_high %}
                        {{ stock_data.week52_low }} ~ {{ stock_data.week52_high }}
                        {% else %}
                        N/A
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- News Tab -->
    <div id="news-tab" class="tab-content">
        <div class="glass-panel">
            <h3>ğŸŒ ì‹¤ì‹œê°„ ë‰´ìŠ¤ ë° ì‹œì¥ ì‹¬ë¦¬</h3>
        </div>

        {% if stock_data.sentiment_details %}
        <div class="glass-panel sentiment-summary">
            <div class="sentiment-item">
                <div class="sentiment-label">í‰ê·  ê°ì„± ì ìˆ˜</div>
                <div class="sentiment-value">{{ "{:.2f}".format(stock_data.sentiment_score) }}</div>
                <div class="sentiment-range">(-1.0 ~ 1.0)</div>
            </div>
            <div class="sentiment-item">
                <div class="sentiment-label">ë¶„ì„ëœ ë‰´ìŠ¤</div>
                <div class="sentiment-value">{{ stock_data.news_count }}</div>
                <div class="sentiment-range">ê°œ</div>
            </div>
        </div>

        <div class="news-list">
            {% for item in stock_data.sentiment_details %}
            <details class="news-item">
                <summary>
                    <span class="sentiment-icon">
                        {% if item.compound > 0.05 %}ğŸŸ¢
                        {% elif item.compound < -0.05 %}ğŸ”´ {% else %}âšª{% endif %} </span>
                            {{ item.translated_title }}
                </summary>
                <div class="news-details">
                    <p><strong>ì¶œì²˜:</strong> {{ item.publisher }}</p>
                    <p><strong>ê°ì„± ì ìˆ˜:</strong> {{ "{:.3f}".format(item.compound) }}</p>
                    {% if item.link and item.link != '#' %}
                    <p><a href="{{ item.link }}" target="_blank">ê¸°ì‚¬ ì½ê¸°</a></p>
                    {% endif %}
                </div>
            </details>
            {% endfor %}
        </div>
        {% else %}
        <div class="glass-panel">
            <p>'{{ stock_data.ticker }}'ì— ëŒ€í•œ ìµœì‹  ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        {% endif %}
    </div>

    <!-- Advice Tab -->
    <div id="advice-tab" class="tab-content">
        <div class="glass-panel">
            <h3>ğŸ’¡ AI íˆ¬ì ì „ëµ ì œì•ˆ</h3>
        </div>

        {% for advice in stock_data.advice_list %}
        <div class="advice-item" style="border-left-color: {{ advice.color }}; background: {{ advice.color }}22;">
            {{ advice.text }}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Render Plotly chart
    {% if stock_data and stock_data.chart_json %}
    document.addEventListener('DOMContentLoaded', function () {
        var chartData = {{ stock_data.chart_json | tojson | safe
    }};
    if (chartData && chartData.data && chartData.layout) {
        Plotly.newPlot('chart-container', chartData.data, chartData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } else {
        console.error('Chart data is invalid:', chartData);
    }
    });
    {% endif %}

    // Tab functionality
    function showTab(tabName, element) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName + '-tab').classList.add('active');
        element.classList.add('active');
    }

    // Share Functionality
    function shareResult() {
        // Force HTTPS and Production Domain
        // This ensures shared links always point to the live site with correct OG tags.
        // Even if testing on localhost, the shared link will lead to the real site.
        const baseUrl = "https://stock-insight.app";
        const currentParams = window.location.search; // keeps ?ticker=XYZ
        const shareUrl = baseUrl + currentParams;

        if (navigator.share) {
            navigator.share({
                title: '{{ stock_data.company_name }} ë¶„ì„ ê²°ê³¼',
                text: '{{ stock_data.verdict }} - Stock Insight AI',
                url: shareUrl
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(shareUrl).then(function () {
                alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš”.\n(ë³µì‚¬ëœ ì£¼ì†Œ: ' + shareUrl + ')');
            }, function (err) {
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
    }
</script>
{% else %}
<div class="glass-panel welcome-section" style="padding: 1rem 1.25rem; margin-bottom: 1.25rem;">
    <h2 style="font-size: 1.1rem; margin: 0 0 0.25rem 0;">ì£¼ì‹ í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì—¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</h2>
    <p style="color: #64748b; font-size: 0.85rem; margin: 0;">ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì—ì„œ í‹°ì»¤ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì¸ê¸° ì£¼ì‹ì„ ì„ íƒí•˜ì„¸ìš”.</p>
</div>

<!-- AI ì§€ìˆ˜ ì˜ˆì¸¡ ì„¹ì…˜ -->
{% if index_predictions %}
<div class="glass-panel" style="padding: 1.1rem 1.25rem; margin-bottom: 1.25rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
        <div style="display: flex; align-items: center; gap: 0.4rem;">
            <span>ğŸ¤–</span>
            <span style="font-size: 0.9rem; font-weight: 700; color: #e2e8f0;">AI ì˜ˆì¸¡ â€” ë‹¤ìŒ ë‹¬ ì£¼ìš” ì§€ìˆ˜ ë°©í–¥</span>
        </div>
        <a href="/economic-indicators" style="font-size: 0.75rem; color: #38bdf8; text-decoration: none;
           background: rgba(56,189,248,0.08); border: 1px solid rgba(56,189,248,0.25);
           border-radius: 20px; padding: 0.2rem 0.65rem;">
            ìƒì„¸ ë¶„ì„ ë³´ê¸° â†’
        </a>
    </div>
    <div style="display: flex; flex-wrap: wrap; gap: 0.65rem; margin-bottom: 0.75rem;">
        {% for pred in index_predictions %}
        <div style="flex: 1; min-width: 130px;
                    background: rgba({% if pred.direction == 'ìƒìŠ¹' %}74,222,128{% else %}248,113,113{% endif %},0.06);
                    border: 1px solid {{ pred.direction_color }}33;
                    border-radius: 12px; padding: 0.85rem 0.75rem; text-align: center;">
            <div style="font-size: 0.75rem; font-weight: 600; color: {{ pred.color }}; margin-bottom: 0.3rem;">
                {{ pred.name }}
            </div>
            <div style="font-size: 1.7rem; line-height: 1;">{{ pred.direction_icon }}</div>
            <div style="font-size: 1.15rem; font-weight: 800; color: {{ pred.direction_color }}; margin-top: 0.2rem;">
                {{ pred.direction }}
            </div>
            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.3rem;">
                ì‹ ë¢°ë„ <strong style="color: #e2e8f0;">{{ pred.confidence }}%</strong>
            </div>
            <div style="font-size: 0.65rem; color: #475569; margin-top: 0.15rem;">
                ëª¨ë¸ ì •í™•ë„ {{ pred.accuracy }}%
            </div>
        </div>
        {% endfor %}
    </div>
    <p style="color: #475569; font-size: 0.7rem; margin: 0; padding-top: 0.6rem; border-top: 1px solid rgba(255,255,255,0.05);">
        âš ï¸ ê³¼ê±° ë°ì´í„° ê¸°ë°˜ í†µê³„ ëª¨ë¸ (RandomForest). íˆ¬ì ê²°ì •ì— ì§ì ‘ í™œìš©í•˜ì§€ ë§ˆì„¸ìš”.
        ê²½ì œì§€í‘œ: Fed ê¸ˆë¦¬ Â· CPI Â· êµ­ì±„ Â· í™˜ìœ¨ Â· ì‚°ì—…ìƒì‚° Â· ìœ ê°€ Â· VIX
    </p>
</div>
{% endif %}

<!-- AI ê¸ˆìœµ ë‰´ìŠ¤ ë¸Œë¦¬í•‘ (ì½¤íŒ©íŠ¸) -->
{% if news_data %}
<div style="margin-bottom: 1.25rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.65rem; flex-wrap: wrap; gap: 0.4rem;">
        <div style="display: flex; align-items: center; gap: 0.4rem;">
            <span>ğŸ”¥</span>
            <span class="gradient-text" style="font-size: 0.9rem; font-weight: 700;">AI ì‹¤ì‹œê°„ ê¸ˆìœµ ë‰´ìŠ¤ ë¸Œë¦¬í•‘</span>
        </div>
        <span style="font-size: 0.7rem; color: #475569; background: rgba(255,255,255,0.04);
               border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 0.15rem 0.55rem;">
            ë§¤ì‹œê°„ ìë™ ì—…ë°ì´íŠ¸
        </span>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.65rem;">
        {% for news in news_data %}
        <div class="glass-panel" style="padding: 0.85rem 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
            <!-- í—¤ë” -->
            <div style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
                <span style="font-size: 0.68rem; font-weight: 600; padding: 0.15rem 0.45rem; border-radius: 4px;
                      background: {% if news.type == 'êµ­ë‚´' %}rgba(74,222,128,0.15){% else %}rgba(56,189,248,0.15){% endif %};
                      color: {% if news.type == 'êµ­ë‚´' %}#4ade80{% else %}#38bdf8{% endif %};">
                    {{ news.type }}
                </span>
                <span style="font-size: 0.68rem; color: {% if news.sentiment == 'POSITIVE' %}#4ade80{% elif news.sentiment == 'NEGATIVE' %}#f87171{% else %}#94a3b8{% endif %};">
                    {% if news.sentiment == 'POSITIVE' %}ğŸŸ¢{% elif news.sentiment == 'NEGATIVE' %}ğŸ”´{% else %}âšª{% endif %}
                </span>
                <span style="font-size: 0.68rem; color: #475569; margin-left: auto;">{{ news.publisher }}</span>
            </div>
            <!-- ì œëª© -->
            <a href="{{ news.link }}" target="_blank"
               style="text-decoration: none; color: #e2e8f0; font-size: 0.82rem; font-weight: 600;
                      line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2;
                      -webkit-box-orient: vertical; overflow: hidden;">
                {{ news.title }}
            </a>
            <!-- ìš”ì•½ ë¶ˆë › -->
            <ul style="margin: 0; padding-left: 1.1rem; color: #94a3b8; font-size: 0.75rem; line-height: 1.5;">
                {% for point in news.summary[:2] %}
                <li>{{ point }}</li>
                {% endfor %}
            </ul>
            <!-- ì›ë¬¸ ë§í¬ -->
            <a href="{{ news.link }}" target="_blank"
               style="font-size: 0.72rem; color: #38bdf8; text-decoration: none; margin-top: auto;
                      align-self: flex-start;">
                ì›ë¬¸ ë³´ê¸° â†—
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}