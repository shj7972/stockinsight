{% extends "base.html" %}

{% block title %}{% if stock_data %}{{ stock_data.company_name }} ({{ stock_data.ticker }}) - Stock Insight AI{% else
%}Stock Insight AI - ìŠ¤ë§ˆíŠ¸ íˆ¬ì ë¶„ì„ í”Œë«í¼{% endif %}{% endblock %}

{% block content %}
<!-- Major Indices -->
<div class="glass-panel indices-section">
    <h3>ğŸ“Š ì‹¤ì‹œê°„ ê¸€ë¡œë²Œ ì§€ìˆ˜</h3>
    <div class="indices-grid">
        {% for region, indices in indices_data.items() %}
        {% for index in indices %}
        <div class="index-card">
            <div class="index-name">{{ index.name }}</div>
            <div class="index-value">
                {% if region == "í•œêµ­" %}
                {{ "{:,.0f}".format(index.current) }}
                {% else %}
                {{ "{:,.2f}".format(index.current) }}
                {% endif %}
            </div>
            <div class="index-change {% if index.change >= 0 %}positive{% else %}negative{% endif %}">
                {{ "{:+.2f}".format(index.change) }} ({{ "{:+.2f}".format(index.change_pct) }}%)
            </div>
        </div>
        {% endfor %}
        {% endfor %}
    </div>
</div>

{% if stock_data %}
<!-- Stock Analysis Section -->
<div class="stock-header glass-panel {{ stock_data.verdict_class }}">
    <div class="stock-title-section">
        <h1 class="gradient-text">{{ stock_data.company_name }} ({{ stock_data.ticker }})</h1>
        <div class="verdict-badge"
            style="background: {{ stock_data.verdict_color }}22; color: {{ stock_data.verdict_color }}; border-color: {{ stock_data.verdict_color }}44;">
            {{ stock_data.verdict }}
        </div>
        <button class="share-btn" onclick="shareResult()">
            ğŸ”— ê²°ê³¼ ê³µìœ 
        </button>
    </div>
    <div class="stock-price-section">
        <div class="price-label">í˜„ì¬ê°€</div>
        <div class="price-value">{{ stock_data.currency_symbol }}{{ "{:,.2f}".format(stock_data.current_price) }}</div>
        <div class="price-change {% if stock_data.delta >= 0 %}positive{% else %}negative{% endif %}">
            {{ "{:+.2f}".format(stock_data.delta) }}
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="tabs-container">
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('chart', this)">ğŸ“Š ì°¨íŠ¸ & ë¶„ì„</button>
        <button class="tab-btn" onclick="showTab('financial', this)">ğŸ“‹ ì¬ë¬´ ì •ë³´</button>
        <button class="tab-btn" onclick="showTab('news', this)">ğŸ“° ë‰´ìŠ¤ & í‰íŒ</button>
        <button class="tab-btn" onclick="showTab('advice', this)">ğŸ¤– AI ì¡°ì–¸</button>
    </div>

    <!-- Chart Tab -->
    <div id="chart-tab" class="tab-content active">
        <div class="glass-panel" style="padding: 1.5rem;">
            <div id="chart-container" style="width: 100%; height: 650px; min-height: 650px;"></div>
        </div>
    </div>

    <!-- Financial Tab -->
    <div id="financial-tab" class="tab-content">
        <div class="glass-panel">
            <h3>ğŸ“ ê¸°ì—… ê°œìš”</h3>
            <div class="summary-text">{{ stock_data.summary }}</div>
        </div>

        <div class="glass-panel">
            <h3>ğŸ’ ì£¼ìš” ì§€í‘œ</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">ì‹œê°€ì´ì•¡</div>
                    <div class="metric-value">{{ stock_data.market_cap }}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">PER</div>
                    <div class="metric-value">{{ stock_data.pe_ratio }}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ë°°ë‹¹ìˆ˜ìµë¥ </div>
                    <div class="metric-value">
                        {% if stock_data.dividend_yield %}
                        {{ "{:.2f}".format(stock_data.dividend_yield) }}%
                        {% else %}
                        N/A
                        {% endif %}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">PBR</div>
                    <div class="metric-value">{{ stock_data.pbr }}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ROE</div>
                    <div class="metric-value">{{ stock_data.roe }}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">EPS</div>
                    <div class="metric-value">{{ stock_data.eps }}</div>
                </div>
                <div class="metric-card wide-card">
                    <div class="metric-label">52ì£¼ ê°€ê²© ë²”ìœ„</div>
                    <div class="metric-value">
                        {% if stock_data.week52_low and stock_data.week52_high %}
                        {{ stock_data.week52_low }} ~ {{ stock_data.week52_high }}
                        {% else %}
                        N/A
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- News Tab -->
    <div id="news-tab" class="tab-content">
        <div class="glass-panel">
            <h3>ğŸŒ ì‹¤ì‹œê°„ ë‰´ìŠ¤ ë° ì‹œì¥ ì‹¬ë¦¬</h3>
        </div>

        {% if stock_data.sentiment_details %}
        <div class="glass-panel sentiment-summary">
            <div class="sentiment-item">
                <div class="sentiment-label">í‰ê·  ê°ì„± ì ìˆ˜</div>
                <div class="sentiment-value">{{ "{:.2f}".format(stock_data.sentiment_score) }}</div>
                <div class="sentiment-range">(-1.0 ~ 1.0)</div>
            </div>
            <div class="sentiment-item">
                <div class="sentiment-label">ë¶„ì„ëœ ë‰´ìŠ¤</div>
                <div class="sentiment-value">{{ stock_data.news_count }}</div>
                <div class="sentiment-range">ê°œ</div>
            </div>
        </div>

        <div class="news-list">
            {% for item in stock_data.sentiment_details %}
            <details class="news-item">
                <summary>
                    <span class="sentiment-icon">
                        {% if item.compound > 0.05 %}ğŸŸ¢
                        {% elif item.compound < -0.05 %}ğŸ”´ {% else %}âšª{% endif %} </span>
                            {{ item.translated_title }}
                </summary>
                <div class="news-details">
                    <p><strong>ì¶œì²˜:</strong> {{ item.publisher }}</p>
                    <p><strong>ê°ì„± ì ìˆ˜:</strong> {{ "{:.3f}".format(item.compound) }}</p>
                    {% if item.link and item.link != '#' %}
                    <p><a href="{{ item.link }}" target="_blank">ê¸°ì‚¬ ì½ê¸°</a></p>
                    {% endif %}
                </div>
            </details>
            {% endfor %}
        </div>
        {% else %}
        <div class="glass-panel">
            <p>'{{ stock_data.ticker }}'ì— ëŒ€í•œ ìµœì‹  ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        {% endif %}
    </div>

    <!-- Advice Tab -->
    <div id="advice-tab" class="tab-content">
        <div class="glass-panel">
            <h3>ğŸ’¡ AI íˆ¬ì ì „ëµ ì œì•ˆ</h3>
        </div>

        {% for advice in stock_data.advice_list %}
        <div class="advice-item" style="border-left-color: {{ advice.color }}; background: {{ advice.color }}22;">
            {{ advice.text }}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Render Plotly chart
    {% if stock_data and stock_data.chart_json %}
    document.addEventListener('DOMContentLoaded', function () {
        var chartData = {{ stock_data.chart_json | tojson | safe
    }};
    if (chartData && chartData.data && chartData.layout) {
        Plotly.newPlot('chart-container', chartData.data, chartData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } else {
        console.error('Chart data is invalid:', chartData);
    }
    });
    {% endif %}

    // Tab functionality
    function showTab(tabName, element) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName + '-tab').classList.add('active');
        element.classList.add('active');
    }

    // Share Functionality
    function shareResult() {
        // Force HTTPS and Production Domain
        // This ensures shared links always point to the live site with correct OG tags.
        // Even if testing on localhost, the shared link will lead to the real site.
        const baseUrl = "https://stock-insight.app";
        const currentParams = window.location.search; // keeps ?ticker=XYZ
        const shareUrl = baseUrl + currentParams;

        if (navigator.share) {
            navigator.share({
                title: '{{ stock_data.company_name }} ë¶„ì„ ê²°ê³¼',
                text: '{{ stock_data.verdict }} - Stock Insight AI',
                url: shareUrl
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(shareUrl).then(function () {
                alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš”.\n(ë³µì‚¬ëœ ì£¼ì†Œ: ' + shareUrl + ')');
            }, function (err) {
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
    }
</script>
{% else %}
<div class="glass-panel welcome-section">
    <h2>ì£¼ì‹ í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì—¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</h2>
    <p>ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì—ì„œ í‹°ì»¤ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì¸ê¸° ì£¼ì‹ì„ ì„ íƒí•˜ì„¸ìš”.</p>
</div>
{% endif %}
{% endblock %}